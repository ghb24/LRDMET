\documentclass[a4paper,oneside,11pt]{article}
\usepackage{amssymb}
\usepackage{overcite}
\usepackage{amsmath}
\usepackage{enumerate}
\usepackage{graphicx}
\usepackage[nottoc]{tocbibind}
\usepackage{setspace}
\usepackage{rotating}
%\doublespacing
\parindent=0cm
%\parskip=.5cm
\numberwithin{equation}{section}

\newcommand{\rff}[1]{{Eq.~\ref{#1}}}

\newcommand{\half}{\ensuremath{\frac{1}{2}}}
\newcommand{\Rop}{\ensuremath{\mathbf{R}}}
\newcommand{\wfn}[2]{\ensuremath{\psi_{#1}{(#2)}}}
\newcommand{\VEC}[1]{\ensuremath{\mathbf{#1}}}
\newcommand{\pvec}{\ensuremath{\mathbf{p}}}
\newcommand{\rvec}{\ensuremath{\mathbf{r}}}
\newcommand{\kvec}{\ensuremath{\mathbf{k}}}
\newcommand{\Lvec}{\ensuremath{\mathbf{L}}}
\newcommand{\omegavec}{\mathbf{\omega}}
\newcommand{\drdr}{d\mathbf{r}_1d\mathbf{r}_2}
\newcommand{\latvec}[1]{\ensuremath{\mathbf{a}_{#1}}}
\newcommand{\Hamil}{\hat{H}}
\newcommand{\hamil}{\hat{h}}
\newcommand{\Tr}{\mathrm{Tr}}
\newcommand{\DMETBra}{\langle \mathrm{core}|\langle 0|}
\newcommand{\DMETKet}{|0\rangle| \mathrm{core} \rangle}
\newcommand{\Det}[1]{\ensuremath{D_{\mathbf{#1}}}}
\newcommand{\w}[1]{\ensuremath{w_{\mathbf{#1}}}}
\newcommand{\Etilde}[1]{\ensuremath{\tilde{E}_{\mathbf{#1}}}}
\newcommand{\vxc}{\ensuremath{\hat{v}_{\text{xc}}}}
\newcommand{\vext}{\ensuremath{\hat{v}_{\text{ext}}}}
\newcommand{\vhar}{\ensuremath{\hat{v}_{\text{har}}}}
\newcommand{\eigv}[1]{\ensuremath{\varepsilon_{#1}}}
\newcommand{\htdop}{\ensuremath{e^{-\beta\Hamil/P}}}
\newcommand{\rhoel}[1]{\ensuremath{\rho_{\mathbf{#1}}}}
\newcommand{\cyc}[1]{\ensuremath{(\mathbf{#1})}}
\def\Braket#1{\mathinner{\left\langle{#1}\right\rangle}}
\def\braket#1{\mathinner{\langle{#1}\rangle}}
\renewcommand{\thefootnote}{\fnsymbol{footnote}}

\def \bfX {{\bf X}}
\def \bfr {{\bf r}}
\def \bfR {{\bf R}}
\def \bfi {{\bf i}}
\def \ket {{\rangle}}
\def \bra {{\langle}}

\begin{document}

\title{Notes on Linear Response Theory for DMET}
\date{}
\maketitle

\section{Linear Response Theory Fundamentals}
Full background LR theory will be included later, and here we just outline salient points.

Introduce single-frequency harmonic perturbation to the hamiltonian,
\begin{eqnarray}
H_0 \rightarrow H_0 + V^t \\
V^t = \lambda V (e^{i \omega t}+e^{-i \omega t}) .
\end{eqnarray}
The perturbation can also be expressed in the frequency domain as $V^{\omega}$, which acts only at the specified frequency.
We can consider how the expectation of an operator $A$ changes to linear order in the perturbation strength, which defines
the linear response function for a given frequency,
\begin{eqnarray}
\langle \langle A ; V^{\omega} \rangle \rangle = \langle \psi^{(0)} | A | \psi^{(1)}_{\omega} \rangle + \langle \psi^{(1)}_{-\omega} | A | \psi^{(0)} \rangle  ,   \label{LRFunc}
\end{eqnarray}
where $|\psi^{(1)}_{\omega}\rangle$ can be defined in the eigenbasis of the hamiltonian as
\begin{equation}
| \psi^{(1)}_{\omega} \rangle = \sum_{n \neq 0} \frac{ | n \rangle \langle n | V | \psi^{(0)} \rangle}{\omega - (E_n - E_0)} . 
\end{equation}
This results in the Lehmann representation of the linear response function as
\begin{equation}
\langle \langle A ; V^{\omega} \rangle \rangle = \sum_{n \neq 0} \frac{\langle \psi^{(0)} | A | n \rangle \langle n | V | \psi^{(0)} \rangle}{\omega - (E_n - E_0)} - \sum_{n \neq 0} \frac{\langle \psi^{(0)} | V | n \rangle \langle n | A | \psi^{(0)} \rangle}{\omega + (E_n - E_0)} .  \label{Lehmann}
\end{equation}
It can be seen then that the residues of the linear response function give the direct transition moment between the ground and excited state, while the poles identify the direct excitation energies.
Instead of requiring the eigenbasis representation, a set of linear equations can be solved to directly obtain the $|\psi^{(1)}_{\omega}\rangle$, according to
\begin{equation}
(S \omega - (H - E_0))|\psi^{(1)}\rangle = V|\psi^{(0)} \rangle.     \label{LinearSystem}
\end{equation}
Once obtained, the linear response equation can be obtained from Eq.~\ref{LRFunc}.
The time-domain evolution of the expectation value can then be written to first-order as a discrete FT of the linear response function,
\begin{equation}
\langle \psi(t) | A | \psi(t) \rangle = \langle \psi^{(0)} | A | \psi^{(0)} \rangle + \langle \langle A ; V^{\omega} \rangle \rangle e^{-i \omega t} + \langle \langle A ; V^{-\omega} \rangle \rangle e^{i \omega t} .
\end{equation}
In the same way in which static response functions result from the derivatives of the stationary energy series of a perturbation expansion, dynamic response functions result from the 
derivatives of the perturbation expansion of the stationary quasi-energy, defined as the averaged action of
\begin{equation}
\epsilon = \frac{1}{T}\int_0^T dt \langle \psi^{(0)} | H-i\frac{\partial}{\partial t} | \psi^{(0)} \rangle
\end{equation}
This will be written on more later.
Much of the decision therefore rests on how to parameterise this $|\psi^{(1)}_{\omega} \rangle$. In the non-interacting theory, starting from the HF ground state, we can write
\begin{equation}
V^{\omega} = \sum_{ia} \frac{V_{ia} a_a^{+} a_i}{\omega - (\varepsilon_a - \varepsilon_i)}, \label{NonInteractingOperator}
\end{equation}
resulting in
\begin{equation}
|\psi^{(1)} \rangle = \sum_{ia} \frac{V_{ia} a_a^{+} a_i}{\omega - (\varepsilon_a - \varepsilon_i)} |\psi^{(0)} \rangle,    \label{NonInteractingPhi1}
\end{equation}
which can be inserted into Eq.~\ref{LRFunc} to obtain the non-interacting linear response function.
RPA (LR-HF), you can consider the space of the hamiltonian as consisting of all single excitations and de-excitations of the Hartree--Fock reference. This results in a slightly different
form for the linear response function, since an explicit form for $|\psi^{(1)} \rangle$ is not obtained, and eigenvectors of the hamiltonian rather represent generalized excitation operators 
(linear combination of excitation and deexcitation).
This results in transition moments needing to be evaluated as commutators with the perturbation. The deexcitation operators are required to ensure that the time-dependent observable remains
one which is expressible by a single determinant constructed from all rotations among all possible determinants in the space. If the deexcitation operators are omitted, then an explicit 
expression for $|\psi^{(1)} \rangle$
can be obtained, resulting from the Tamm-Dancoff approximation, or CIS, and (for instance) Eq.~\ref{Lehmann} can be used directly to obtain the linear response function.

In these notes, we will restrict ourselves to a density-density linear response function at a local site $\phi_{\alpha}$, with $A = \lambda V = a_{\alpha}^{+} a_{\alpha}$, 
resulting in the transitions corresponding to 
number-conserving (neutral) excitations. Therefore, in e.g. Eq.~\ref{NonInteractingOperator}, $V_{ia} = \langle i | a_{\alpha}^{+} a_{\alpha} | a \rangle$.

\section{DMET-LR Background}

In DMET, we aim to self-consistently solve both a mean-field problem, and an impurity problem. The mean-field problem results in a set of delocalized orbitals, which are then transformed into a specific
set of doubly-occupied core and virtual orbitals, as well as an active set of orbitals in which to perform a CAS calculation (FCI for these purposes). There are $2 \times$ the number of impurity sites in
this CAS space, and represent the full impurity orbital space, along with a bath of the same size which contains {\em all} the one-electron coupling to the mean-field determinant orbitals. 
This embedded basis therefore
contains the full space of the impurity, as well as the full coupling to the rest of the space at the mean-field level. At self-consistency, a correlation potential is applied over the impurity space,
such that the 1RDM of the mean-field and the FCI high-level RDM in the embedded system match.

In order to do linear response on the wavefunction from this embedded system, we want to combine the optimised active space of the ground state DMET theory, with that of strongly contracted basis of single
excitations present in the non-interacting perturbation operator in Eq.~\ref{NonInteractingOperator}. The strongly contracted basis is reminiscent of the strongly contracted basis of NEVPT2, but in this
case is soley for one-electron operators. In addition, as long as the perturbation is chosen to act locally at an impurity site, i.e. $\phi_{\alpha} \in \{\phi_{\textrm{imp}}\}$, 
then $V |\psi^{(0)} \rangle$ is entirely spanned by the original CAS space, regardless of the $|\psi^{(0)} \rangle$ expressed in this space, since the full orbital space of $\phi_{\alpha}$ is 
included in the space. In full MCLR, all single excitations and deexcitations would then be included on top of the CAS space; from the core to the virtual space, the core to active space, and active to virtual.
In order to retain the feature of DMET that the explicit space of the wavefunction does not scale with the size of the underlying system, these single excitations first internally contracted (in keeping
with MCLR), whereby the excitation operators act on the $|\psi^{(0)} \rangle$ as a whole, and then are also strongly contracted, whereby they are collected and parameterized according contraction
coefficients obtained from the non-interacting theory.

\subsection{Spaces \& Notation}

Writing the optimized DMET $|\psi^{(0)} \rangle$ as
\begin{equation}
|\psi^{(0)} \rangle = \DMETKet ,
\end{equation}
where the $|0 \rangle$ represents the wavefunction in the CAS space, we can denote the {\em spatial} orbital space which the schmidt basis spans 
as $\{i,j,k\} \in \textrm{core}$, $\{a,b,c\} \in \textrm{virtual}$, and greek indices $\{ \alpha,\beta,\gamma,\delta,\mu,\lambda \} \in \textrm{active}$. There are $n_{emb}$ spatial 
orbitals in the active space in which $|0 \rangle$ is represented. For future use $\{p,q,r,s\}$ represent general orbitals over all space.
We want to construct the hamiltonian in the basis the full CAS space, and include coupling to the spaces of
\begin{eqnarray}
\chi^{CV} = \sum_{ia} G_{ia}(\omega) a_a^{+} a_i |0\rangle |core\rangle \\
\chi^{AV}_{\beta} = \sum_{a} G_{\beta a}(\omega) a_a^{+} a_{\beta} |0\rangle |core\rangle \\
\chi^{CA}_{\beta} = \sum_{i} G_{i \beta}(\omega) a_{\beta}^{+} a_{i} |0\rangle |core\rangle , \\
\end{eqnarray}
where superscripts CV stand for strongly contracted `core-virtual' excitations, AV is for the `active-virtual', and CA for `core-active'. The contraction matrix, $G(\omega)$, is obtained from projecting the
form for the non-interacting operator in the mean-field basis (Eq.~\ref{NonInteractingOperator}) into the (full) Schmidt basis as defined above. Note that this is only obtained for a specific
frequency, and therefore will need to be recalculated each time over a frequency sweep. This explicit $\omega$ dependence will be omitted and implied from now on for brevity. 

Initially, the AV and CA excitations remain defined for
each active space spin-orbital $\beta$, and have yet to be spin-integrated. Therefore the resulting size of the linear equations is the size of the original CAS determinant space, plus $4 \times n_{emb}$
functions corresponding to $\chi^{AV}_{\beta}$ and $\chi^{CA}_{\beta} \forall \beta \in$ the active orbital space, and a single function corresponding to $\chi^{CV}$.

We note that the DMET hamiltonian only contains two-electron terms over the impurity space (a subspace of the full embedded `active' system). However, the calculation of the hamiltonian in the 
basis described above, will also include 3RDMs when considering the two-electron elements between AV or CA `internal` excitations, since there are two active space fermion operators, as well as the 
two electron operator from the hamiltonian. These will be dealt with (see below) via an RI onto the N+1/N-1 electron space in the active basis. Essentially, the operators on each side of the
expectation value are explicitly applied to give e.g.
\begin{equation}
|0^{(-1)}_{\beta} \rangle = a_{\beta} |0\rangle ,
\end{equation}
from which transition density matrices are constructed from these functions. More details on this will be given below. One other point is that since no orbitals are now canonical HF orbitals,
the one-electron operator in the space is no longer diagonal.

\section{Implementation}
Here I will go through the construction of the individual terms, as they are coded up, and for brevity will omit the `$a$' in the use of fermionic operators.
\subsection{Normalization}
The strongly contracted functions given above which define the space in which we want to construct the hamiltonian are not normalized, and initially the normalization constants are calculated.
\begin{align}
N^{(CV)} &= \sum_{ijab} G_{ia} G_{jb} \DMETBra j^{+} b a^{+} i \DMETKet \\
&= 2\sum_{ai} |G_{ai}|^2    \\
N^{(AV)}_{\beta} &= \sum_{ab} G_{\beta a} G_{\beta b} \DMETBra \beta^{+} b a^{+} \beta \DMETKet \\
&= \frac{1}{2} D_{\beta \beta} \sum_{a} |G_{\beta a}|^2    \label{AVNorm} \\
N^{(CA)}_{\beta} &= \sum_{ij} G_{i \beta} G_{j \beta} \DMETBra j^{+} \beta \beta^{+} i \DMETKet \\
&= \left(1-\frac{1}{2} D_{\beta \beta} \right) \sum_{i} |G_{i \beta}|^2     \label{CANorm}
\end{align}
where $D$ is the {\em spin-free} one-electron RDM. The factor of two in $N^{(CV)}$ comes from the spin integration, since the ai run over both spin-types, but the internal excitations only
run over one spin-type for the active orbital.

\subsection{Hessian construction}
There are ten seperate blocks of the hamiltonian which need to be constructed. The first consists of just the uncontracted CAS determinant space, which is identical to the hamiltonian operator
in which the high-level calculation acted. The others need to be derived, as given below.

\subsubsection{Diagonal element of core-virtual excitation}
The expression for the diagonal hamiltonian matrix element for the CV excitation is
\begin{equation}
\frac{1}{N^{(CV)}}\sum_{ijabpq} G_{jb} G_{ia} f_{pq} \DMETBra j^{+} b p^{+} q a^{+} i \DMETKet ,
\end{equation}
where $f_{pq}$ are elements of the one-electron mean-field operator. Evaluating the expectation value gives
\begin{equation}
\delta_{bp} \delta_{qa} \delta_{ij} - \delta_{ab} \delta_{jq} \delta_{ip} + \delta_{ab} \delta_{ij} \langle p^{+} q \rangle
\end{equation}
After spin integration, this gives
\begin{equation}
\frac{1}{N^{(CV)}} \left( 2\sum_{iab} G_{ib} G_{ia} f_{ba} - 2\sum_{ija} G_{ja} G_{ia} f_{ij} + 4 \sum_{ija} G_{ia} G_{ia} f_{jj} + 2 \sum_{ai \beta \gamma} G_{ia} G_{ia} \gamma_{\beta \gamma} f_{\beta \gamma} \right) . \label{1eCVDiag}
\end{equation}
The two electron term gives
\begin{equation}
\sum_{\beta \gamma \delta \mu} (\beta \gamma | \delta \mu) d_{\beta \gamma \delta \mu}  \label{2eCVDiag}
\end{equation}
where $d_{\beta \gamma \delta \mu} = \sum_{\sigma \tau} \langle 0| \beta^{+}_{\sigma} \delta^{+}_{\tau} \mu_{\tau} \gamma_{\sigma} | 0 \rangle$ is the spin-free 2RDM over the active space. 
This final contrubtion is just the two electron energy over the active space -- we will return to this later.

\subsubsection{Coupling between core-virtual excitation and uncontracted determinant space}
\begin{equation}
\frac{1}{\sqrt{N^{(CV)}}} \sum_{iapq} G_{ia} f_{pq} \langle \textrm{core} |\langle D_J | p^{+} q a^{+} i \DMETKet ,
\end{equation}
where $| D_J \rangle$ is an active space uncontracted determinant, with a corresponding FCI coefficient $C_J$ in $|0\rangle$. Evaluating the matrix element and spin-integrating gives
\begin{equation}
\frac{2}{\sqrt{N^{(CV)}}} C_J \sum_{ia} G_{ia} f_{ia} .
\end{equation}
The two-electron term does not couple.

\subsubsection{Diagonal block between Active-Virtual internal excitations}
\label{sec:AVDiag}
The one electron contribution to these matrix elements is given by
\begin{equation}
\frac{1}{\sqrt{N^{(AV)}_{\beta}N^{(AV)}_{\gamma}}} \sum_{apqb} G_{\beta b} G_{\gamma a} f_{pq} \DMETBra \gamma^{+} a p^{+} q b^{+} \beta \DMETKet
\end{equation}
The expectation value evaluates to
\begin{equation}
\delta_{ap} \delta_{qb} \langle \gamma^{+} \beta \rangle + \delta_{ab} \langle \gamma^{+} p^{+} q \beta \rangle
\end{equation}
From which we can partially spin-integrate (remembering that $\beta$ and $\gamma$ refer to specific spin-orbitals) to give the expression
\begin{equation}
\frac{1}{\sqrt{N^{(AV)}_{\beta}N^{(AV)}_{\gamma}}} \left( \frac{D_{\gamma \beta}}{2} \sum_{ab} G_{\beta b} G_{\gamma a} f_{ab} + D_{\gamma \beta} \sum_{ai} G_{\beta a} G_{\gamma a} f_{ii} + \frac{1}{2}\sum_{a \delta \mu} G_{\beta a} G_{\gamma a} d_{\gamma \beta \delta \mu} f_{\delta \mu} \right ) \label{DiagAVBlock}
\end{equation}
The two electron part requires the evaluation of the expectation value
\begin{equation}
\langle 0 | \gamma^{+} a \delta^{+} \mu^{+} \lambda \nu b^{+} \beta | 0 \rangle = \delta_{ab} \langle 0 | \gamma^{+} \delta^{+} \mu^{+} \lambda \nu \beta | 0 \rangle
\end{equation}
Unfortunately, to evaluate exactly required 3-particle RDMs. This is avoided by precomputing the N-1 electron wavefunction
\begin{equation}
|0^{(-1)}_{\beta} \rangle = \sum_J |D_J^{(-1)} \rangle \langle D_J^{(-1)} | a_{\beta} |0\rangle ,
\end{equation}
where $D_J^{(-1)}$ represents the uncontracted N-1 electron determinant space spanned by the active orbitals.
Once this is obtained, transition density matrices between these N-1 electron functions can be used instead of higher-ranked density matrices between the N-electron ground state, i.e.
\begin{equation}
(d^T_{\beta \gamma})_{\delta \nu \mu \lambda} = \langle 0^{(-1)}_{\beta} | \delta^{+} \mu^{+} \lambda \nu | 0^{(-1)}_{\gamma} \rangle = \langle 0 | \gamma^{+} \delta^{+} \mu^{+} \lambda \nu \beta | 0 \rangle
\end{equation}
In this way, we only need to evaluate and store 2-RDMs for all needs. It may however be easier in the end to simply construct the 3RDMs as needed - this is to test.
The final two-electron energy expression for this block is therefore
\begin{equation}
\frac{1}{2 \sqrt{N^{(AV)}_{\beta}N^{(AV)}_{\gamma}}} \sum_{a \delta \nu \mu \lambda} G_{\beta a} G_{\gamma a} (d^T_{\beta \gamma})_{\delta \nu \mu \lambda} (\delta \nu | \mu \lambda)   \label{DiagAVBlock2e}
\end{equation}
Care needs to be taken - $\gamma$ and $\beta$ correspond to spin-orbitals, but we need to full spin-integrate the $(d^T_{\beta \gamma})_{\delta \nu \mu \lambda}$ term. There is clearly no term
between $\gamma$ and $\beta$ of different spin. This is something to check against
the 3RDMs, but will not affect non-interacting limit, so not my first place I am checking now...

\subsubsection{Coupling between active-virtual excitations and the uncontracted determinant space}
The one-electron coupling is given by
\begin{equation}
\frac{1}{\sqrt{N_{\beta}^{(AV)}}} \sum_{apq} G_{\beta a} f_{pq} \langle \textrm{core} | \langle D_J | p^{+} q a^{+} \beta \DMETKet
\end{equation}
which evaluates to
\begin{equation}
\frac{1}{\sqrt{N_{\beta}^{(AV)}}} \sum_{\gamma a} G_{\beta a} f_{\gamma a} \langle D_J | \gamma^{+} \beta | 0 \rangle
\end{equation}
Algorithmically, you do not want to loop over $\gamma$, but rather loop over the FCI wavefunction, before calculating whether it couples via a single excitation to $D_J$. The parity factor of 
$\langle D_J | \gamma^{+} \beta | 0 \rangle$ needs also to be calculated, and can introduce a sign change. It is also possible to reuse the N-1 electron $|0^{(-1)}_{\beta} \rangle$ wavefunction calculated
earlier for more efficiency, and this can be a test. $\gamma^{+}$ would then be sequentially applied to each element in this wavefunction. Parities would however still need to be calculated.
The two-electron term again does not couple.

\subsubsection{Coupling between active-virtual excitations and the strongly contracted core-virtual excitation}
The one electron coupling is given by
\begin{equation}
\frac{1}{\sqrt{N^{(CV)}N^{(AV)}_{\beta}}} \sum_{iabpq} G_{ia} G_{\beta b} f_{pq} \DMETBra i^{+} a p^{+} q b^{+} \beta \DMETKet
\end{equation}
The expectation value is
\begin{equation}
\DMETBra i^{+} a p^{+} q b^{+} \beta \DMETKet = -\delta_{ab} \delta_{iq} \DMETBra p^{+} \beta \DMETKet   ,
\end{equation}
which results in the matrix element
\begin{equation}
-\frac{1}{2 \sqrt{N^{(CV)}N^{(AV)}_{\beta}}} \sum_{ia \gamma} G_{ia} G_{\beta a} f_{\gamma i} D_{\gamma \beta} .
\end{equation}
No two-electron term.

\subsubsection{Diagonal block between core-active internal excitations}
The one-electron component is given as 
\begin{equation}
\frac{1}{\sqrt{N^{CA}_{\beta} N^{(CA)}_{\gamma}}} \sum_{ijpq} G_{i \beta} G_{j \gamma} f_{pq} \DMETBra j^{+} \gamma p^{+} q \beta^{+} i \DMETKet     \label{CABlock}
\end{equation}
The expectation value can be evaluated and reduced to canonical form as
\begin{eqnarray}
-\delta_{jq}\delta_{pi}\delta_{\beta \gamma} + \delta_{jq}\delta_{pi}\langle \beta^{+} \gamma \rangle + \delta_{ij} \delta_{p \gamma} \delta_{q \beta} - \delta_{ij} \delta_{p \gamma} \langle \beta q \rangle \\ \notag
- \delta_{ij} \delta_{q \beta} \langle p^{+} \gamma \rangle + \delta_{ij} \delta_{\gamma \beta} \langle p^{+} q \rangle - \delta_{ij} \langle p^{+} \beta^{+} \gamma q \rangle
\end{eqnarray}
These terms are spin-integrated where possible, and divided into terms which only act on the diagonal (contains $\delta_{\gamma \beta}$ - terms 1 \& 6), 
which consist of (note that the normalization factor in Eq.~\ref{CABlock} is implied and omitted for readability)
\begin{equation}
-\sum_{ij} G_{j \beta} G_{i \beta} f_{ij} + \sum_{i \delta \lambda} G_{i \beta} G_{i \beta} f_{\delta \lambda} D_{\delta \lambda} + 2 \sum_{ij} G_{i \beta} G_{i \beta} f_{jj}
\end{equation}
The other one-electron terms act on all elements in the block, and consist of (again, normalization omitted)
\begin{eqnarray}
\frac{1}{2} \sum_{ij} G_{j \gamma} G_{i \beta} f_{ij} D_{\beta \gamma} + \sum_{i} G_{i \gamma} G_{i \beta} f_{\gamma \beta} - \frac{1}{2} \sum_{i \delta} G_{i \gamma} G_{i \beta} f_{\gamma \delta} D_{\beta \delta}  \notag \\ 
- \frac{1}{2} \sum_{i \delta} G_{i \gamma} G_{i \beta} f_{\delta \beta} D_{\delta \gamma} - \sum_{ij} G_{i \gamma} G_{i \beta} f_{jj} D_{\beta \gamma} - \frac{1}{2} \sum_{i \delta \lambda} G_{i \gamma} G_{i \beta} f_{\delta \lambda} d_{\delta \lambda \beta \gamma} .
\end{eqnarray}
Obviously, many of these terms factorize and can be evaluated more efficiently, but here they are written out in full.
The two-electron term is given by
\begin{equation}
\frac{1}{\sqrt{N^{CA}_{\beta} N^{(CA)}_{\gamma}}} \sum_{ij \delta \lambda \mu \nu} G_{i \beta} G_{j \gamma} (\delta \lambda | \mu \nu) \DMETBra j^{+} \gamma \delta^{+} \mu^{+} \nu \lambda \beta^{+} i \DMETKet
\end{equation}
which reduces to
\begin{equation}
\frac{1}{\sqrt{N^{CA}_{\beta} N^{(CA)}_{\gamma}}} \sum_{i \delta \lambda \mu \nu} G_{i \beta} G_{i \gamma} (\delta \lambda | \mu \nu) \DMETBra \gamma \delta^{+} \mu^{+} \nu \lambda \beta^{+} \DMETKet
\end{equation}
As in section \ref{sec:AVDiag}, this expectation value can be evaluated either by reducing it to canonical form and constructing the 3RDM, or by evaluating two-body transition density matrices between
N+1 electron wavefunctions. If the 3RDM is to be used, many more terms will result than for the active-virtual analogue, since previously it was already in a canonical representation for the 3RDM.
Here, lower-ranked RDMs will also be produced. Care is also needed therefore in the spin-integration.

\subsubsection{Coupling between core-active internal excitations and the uncontracted CAS determinants}
The one-electron contribution is
\begin{equation}
\frac{1}{\sqrt{N^{(CA)}_{\beta}}} \sum_{ipq} G_{i \beta} f_{pq} \langle \textrm{core} | \langle D_J | p^{+} q \beta^{+} i \DMETKet
\end{equation}
This can be written as
\begin{equation}
\frac{1}{\sqrt{N^{(CA)}_{\beta}}} \sum_{i \delta} G_{i \beta} f_{i \delta} \langle D_J | \delta \beta^{+} | 0 \rangle
\end{equation}
We have to be careful here, since the matrix element is not in a canonical form. We could either reduce it to canonical form (in which case we would obtain a $\delta_{\delta \beta}$ term), or leave it in this
form, since we already have the N+1 electron wavefunction stored according to $\beta^{+} | 0 \rangle$. In this case the parities need be be flipped when $\beta \neq \delta$, or include diagonal RDM contributions
when $\beta = \delta$. This is something I need to rigourously check. To check, it is equivalent to form the transistion RDM between the states for all $\delta$.

\subsubsection{Coupling between core-active internal excitations and strongly contracted CV excitation}
The one-electron contribution is
\begin{equation}
\frac{1}{\sqrt{N^{(CV)} N^{(CA)}_{\beta}}} \sum_{ijapq} G_{ja} G_{i \beta} f_{pq} \DMETBra j^{+} a p^{+} q \beta^{+} i \DMETKet
\end{equation}
The expectation value reduces to
\begin{equation}
\delta_{ap} \delta_{ij} \delta_{q \beta} - \delta_{ap} \delta_{ij} \langle \beta^{+} q \rangle
\end{equation}
Spin-integrating, the full term is therefore
\begin{equation}
\frac{1}{\sqrt{N^{(CV)} N^{(CA)}_{\beta}}} \sum_{ai} G_{ia} G_{i \beta} f_{a \beta} - \frac{1}{2 \sqrt{N^{(CV)} N^{(CA)}_{\beta}}} \sum_{a i \gamma} G_{ia} G_{i \beta} f_{a \gamma} D_{\beta \gamma}
\end{equation}

\subsubsection{Coupling between the core-active internal excitations and active-virtual internal excitations}
This can be written as
\begin{equation}
\frac{1}{\sqrt{N^{(AV)}_{\beta} N^{(CA)}_{\gamma}}} \sum_{aipq} G_{i \beta} G_{\gamma a} f_{pq} \DMETBra \gamma^{+} a p^{+} q \beta^{+} i \DMETKet
\end{equation}
This expectation value evaluates to zero for all $\gamma$ and $\beta$, and therefore there is no coupling between the different classes for internal excitations.

\subsection{Overlap matrix}

All functions have been explicitly normalized, but not all of them are orthogonal to each other. 
Within each class of internal excitations, we have to explicitly construct the overlap matrix in this block.

\subsubsection{Active-virtual excitation overlap}
The overlap of these functions is given by
\begin{equation}
S^{(AV)}_{\beta \gamma} = \frac{1}{\sqrt{N^{(AV)}_{\beta} N^{(AV)}_{\gamma}}} \sum_{ab} G_{b \beta} G_{a \gamma} \DMETBra \gamma^{+} a b^{+} \beta \DMETKet
\end{equation}
Evaluating this gives
\begin{equation}
S^{(AV)}_{\beta \gamma} = \frac{1}{2 \sqrt{N^{(AV)}_{\beta} N^{(AV)}_{\gamma}}} \sum_{a} G_{a \beta} G_{a \gamma} D_{\beta \gamma}
\end{equation}
Expanding out the normalization according to Eq.~\ref{AVNorm}, it can be seen as a check that $S^{(AV)}_{\beta \beta} = 1$ as expected.

\subsubsection{Core-Active excitation overlap}
Similarly, the overlap of the core-active excitation block is given by
\begin{equation}
S^{(CA)}_{\beta \gamma} = \frac{1}{\sqrt{N^{(CA)}_{\beta} N^{(CA)}_{\gamma}}} \sum_{ij} G_{i \beta} G_{j \gamma} \DMETBra i^{+} \beta \gamma^{+} j \DMETKet
\end{equation}
Evaluating this gives an additional diagonal term compared to the active-virtual block:
\begin{equation}
S^{(CA)}_{\beta \gamma} = \frac{1}{\sqrt{N^{(AV)}_{\beta} N^{(AV)}_{\gamma}}} \left ( \sum_i \delta_{\beta \gamma} G_{i \beta} G_{i \beta} - \frac{1}{2} \sum_{i} G_{i \beta} G_{i \gamma} D_{\gamma \beta} \right)
\end{equation}
Once again, substituting in the normalization according to Eq.~\ref{CANorm} gives unity as expected for $\beta = \gamma$.

\subsection{Setup of final equations}

We now want to construct and solve for $|\psi^{(0)} \rangle$ as given in Eq.~\ref{LinearSystem}. The first thing that is done, is to remove the redundant ground state eigenvector from the hamiltonian
matrix that we have constructed. This involves a double loop over the CAS space in which $|\psi^{(0)} \rangle$ is defined:
\begin{equation}
H \rightarrow H - |\psi^{(0)} \rangle E_0 \langle \psi^{(0)} |
\end{equation}
Next, we need to offset the `zeroth-order' energy from the diagonals of the hessian. This needs care, to consider what exactly constitutes this in each block. In the uncontracted CAS space, this is 
just the energy from the diagonalization, $E_0$, since the determinant basis is constructed without reference to the core contribution.

For the core-virtual excitation, we have terms corresponding to the zeroth-order energy, both in the same way as the determinant space ($E_0$), but also from the 1-electron core energy contribution.
These terms correspond to the final two terms in Eq.~\ref{1eCVDiag}, and Eq.~\ref{2eCVDiag}. These are therefore neglected in the construction of the diagonal element for the core-virtual excitation. In 
section \ref{sec:ReductionofCV} we analytically prove that these are the correct terms to subtract, to ensure that this term leads to the non-interacting equations when taken in isolation.

The diagonal hamiltonian terms of the active-virtual excitations (Eq. \ref{DiagAVBlock} \& Eq. \ref{DiagAVBlock2e}) can be rewritten as
\begin{equation}
\frac{\sum_{ab} G_{\beta a} G_{\beta b} f_{ab}}{\sum_a G_{\beta a} G_{\beta a}} + 2 \sum_i f_{ii} + \frac{\sum_{\delta \mu} d_{\beta \beta \delta \mu} f_{\delta \mu}}{D_{\beta \beta}} + \frac{1}{D_{\beta \beta}} \sum_{\delta \nu \mu \lambda} \langle \beta^{+} \delta^{+} \mu^{+} \lambda \nu \beta \rangle (\delta \nu | \mu \lambda)
\end{equation}
The second term is the same core contribution to the zeroth order energy as for the CV excitation, and is therefore removed, but it is not obvious at the moment whether the last two terms reduce to 
the full active space energy. This is something to consider further, but for the moment, the energy which is subtracted from the diagonal is the same as for the CV excitation, i.e. the core energy, and the 
FCI active space energy. The CA excitations are dealt with similarly.

We then construct the final matrix as $S\omega - (H-E^{(0)})$.

Finally, the $V|\psi^{(0)} \rangle = \alpha^{+} \alpha |0 \rangle$ vector needs to be constructed. 
Since the $\alpha$ space is entirely spanned by a single orbital in the active space, this function does not couple
to the space of contracted excitations, and remains within the CAS space, and we can write it as
\begin{equation}
V|\psi^{(0)} \rangle = \sum_J C_J |D_J \rangle \langle D_J | \alpha^{+} \alpha | D_J \rangle    .
\end{equation}
All determinants which have $\phi_{\alpha}$ (either spin) occupied will contribute.

\subsection{Linear response function}
The linear equations which have been constructed, and are solved (just DGESV currently, rather than an iterative scheme) for $|\psi^{(1)}_{\omega} \rangle$. The linear response function can then be
constructed as in Eq.~\ref{LRFunc} (but just for $+\omega$ term) as
\begin{equation}
\langle \langle V ; V^{\omega} \rangle \rangle = \langle \psi^{(0)} | V | \psi^{(1)}_{\omega} \rangle = \langle \psi^{(0)} | \alpha^{+} \alpha | \psi^{(1)}_{\omega} \rangle
\end{equation}
Once again, this only acts on the determinants in the CAS space, in a similar way in which $V|\psi^{(0)} \rangle$ was constructed, constructing sums of $C^{(0)}_J C^{(1)}_J$ if either of the spin orbitals
of $\phi_{\alpha}$ are occupied.

Alternative constructions to check for consistency can be formulated, including construction of the transition 1RDM over the entire space, of 
$\langle \psi^{(0)} | p^{+} q | \psi^{(1)}_{\omega} \rangle$, and rotating into the AO space, before extracting the $\alpha \alpha$ component.
In addition, a complete diagonalization can be performed rather than DGESV, and the Lehmann representation of the function constructed, according to Eq.~\ref{Lehmann}. These should all agree.

\section{Issues/Tests}

\begin{itemize}
\item Non-interacting theory, TDA, and RPA should all reduce to the same non-interacting limit.
\item Ensuring reduction to the non-interacting limit as $U \rightarrow 0$ and active space vanishes -- see section~\ref{sec:ReductionofCV}. 
\item Ensure all three ways to construct the final linear respose function are equivalent.
\item To test the $N\pm1$ RI for the higher-ranked RDMs, explicitly calculate 3RDMs on the fly to compare to transition 2RDMs over $N\pm1$ spaces. 
(This should not affect $U\rightarrow0$ limit). Also, changing various 2RDMs in the theory
to similar transition 1RDMs over the $N\pm1$ spaces should not affect the results.
\item Ensure that without the contracted functions, and just the determinant space, the poles of the resultant LR function are at the active space FCI transition frequencies.
\item In a diagonal approximation for the hessian, at the $U\rightarrow 0$ limit, we should return to the non-interacting limit, along with poles at the different in the determinantal energies?
\end{itemize}

\subsubsection{Reduction of strongly contracted core-virtual excitation to non-interacting limit}
\label{sec:ReductionofCV}
Assume we have no active space, and the space reduces to the canonical HF orbital space. In this limit, the strongly contracted core-virtual excitation
alone should reproduce the non-interacting limit, which is orthogonal to the ground state. In this case, the matrix consists of only one function, and thus, the linear response function can be
written as (if we are just considering the $+\omega$ contribution - more on this later)
\begin{equation}
\langle \langle V ; V \rangle \rangle = \frac{\langle 0 | V | 1 \rangle \langle 1 | V | 0 \rangle}{\omega - E}  ,   \label{CVLR}
\end{equation}
where (ignoring spin for simplicitly),
\begin{align}
|1 \rangle &= \frac{1}{\sqrt{N}} \sum_{ia} G_{ia} a^{+} i | HF \rangle  \\
|0 \rangle &= |HF \rangle   \\
G_{ia} &= \frac{ \langle i | V | a \rangle }{\omega-(\epsilon_a - \epsilon_i)}   \\ 
N &= \sum_{ia} G_{ai} G_{ia} \\
V &= \alpha^{+} \alpha  .
\end{align}
The hamiltonian matrix element of Eq.~\ref{1eCVDiag} is taken to be in the canonical basis (removing the `zeroth' energy contribution as discussed above), which gives
\begin{equation}
E = \frac{1}{N} \sum_{ia} G_{ai} G_{ia} (\epsilon_a - \epsilon_i)
\end{equation}
We find that
\begin{equation}
\langle 0 | p^{+} q | 1 \rangle = \frac{1}{\sqrt{N}} G_{ia} \delta_{pi} \delta_{qa}
\end{equation}
Rotating this into the AO basis, and extracting the $\alpha \alpha$ component of the resultant transition density matrix in the AO basis, gives
\begin{align}
\langle 0 | \alpha^{+} \alpha | 1 \rangle &= \frac{1}{\sqrt{N}} \sum_{ia} C_{\alpha i} G_{ia} C_{\alpha a}     \\
&= \frac{1}{\sqrt{N}} \sum_{ia} \frac{\langle i | \alpha^{+} \alpha | a \rangle C_{\alpha i} C_{\alpha a}}{\omega - (\epsilon_a - \epsilon_i)}
\end{align}
where $C_{\alpha i}$ represents MO transformation matrix, giving the $\alpha$ component of the $i^{\textrm{th}}$ MO.
Since
\begin{equation}
C_{\alpha i} C_{\alpha a} = \langle a | \alpha^{+} \alpha | i \rangle ,
\end{equation}
we can write
\begin{equation}
\langle 0 | \alpha^{+} \alpha | 1 \rangle = \frac{1}{\sqrt{N}} \sum_{ia} \frac{\langle i | \alpha^{+} \alpha | a \rangle \langle a | \alpha^{+} \alpha | i \rangle}{\omega - (\epsilon_a - \epsilon_i)}
\end{equation}
Subbing this into Eq.~\ref{CVLR} gives
\begin{equation}
\langle \langle V ; V \rangle \rangle = \frac{ \frac{1}{N} \left( \sum_{ia} \frac{\langle i | \alpha^{+} \alpha | a \rangle \langle a | \alpha^{+} \alpha | i \rangle }{ \omega - (\epsilon_a - \epsilon_i)} \right)^2}{\omega - \frac{1}{N} \sum_{ia} G_{ia} G_{ai} (\epsilon_a - \epsilon_i)} \label{asd}
\end{equation}
Multiplying the numerator and denominator by $N$, and considering the denominator in isolation, gives
\begin{align}
& \sum_{ia} \frac{\omega|\langle i | \alpha^{+} \alpha | a \rangle |^2 - (\epsilon_a - \epsilon_i) |\langle i | \alpha^{+} \alpha | a \rangle |^{+}}{(\omega - (\epsilon_a - \epsilon_i))^2}
&=\sum_{ia} \frac{|\langle i | \alpha^{+} \alpha | a \rangle|^2}{\omega - (\epsilon_a - \epsilon_i)} , 
\end{align}
which when substituted into Eq.~\ref{asd}, gives
\begin{equation}
\frac{ \left( \sum_{ia} \frac{|\langle i | \alpha^{+} \alpha | a \rangle |^2}{\omega - (\epsilon_a - \epsilon_i)} \right)^2}{\sum_{ia} \frac{|\langle i | \alpha^{+} \alpha | a \rangle |^2}{\omega - (\epsilon_a - \epsilon_i)}} = \sum_{ia} \frac{|\langle i | \alpha^{+} \alpha | a \rangle |^2}{\omega - (\epsilon_a - \epsilon_i)} ,
\end{equation}
as desired for the ($+ \omega$ component only) non-interacting linear response function. This has been justified both analytically, and numerically in the code.
This also confirms the choice of $E_0$ for the core-virtual excitation as described in the section above.

\section{Further methodological work}

\begin{itemize}
\item Get it working correctly!
\item Full spin-integration of active excitations
\item $-\omega$ term needs to be included in the full linear response function - just repeat calculations with new $G(-\omega)$
\item Increase code efficiency, factorizing terms where possible for efficiency
\item Code up iterative solver for linear equations
\item Different orbital partitioning? Include bath orbitals in the `core' space, and therefore strongly contract their excitations in with the core-virtual ones. This should be relatively straightforward.
\item Compare results to DMRG for the 1D hubbard, and test on 2D hubbard, and on to atomistic model hamiltonians
\item Consider response of correlation potential? At the moment, just LR on Anderson impurity model, since no self-consistency. (note to self: care needed that the correlation potential does not apply over the impurity sites?)
\item Code up uncontracted full MCLR to compare, in both a MR-TDA and MR-RPA fashion
\item Include deexcitations which can have different parameterization in an RPA fashion
\item Consider more accurate contraction coefficients for the strongly contracted functions from the $G(\omega)$ matrix, which could be obtained from TDA or RPA theories?
\item Include small complex component of $\omega$ to obtain spectrum functions from $\Im$ component of LR function
\item Consider particle/hole excitation spectrum to get DoS
\end{itemize}

\end{document}
